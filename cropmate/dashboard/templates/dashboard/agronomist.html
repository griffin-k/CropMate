<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Agronomist - CropMate</title>
    <link rel="icon" href="https://img.freepik.com/premium-vector/agriculture-icon-logo-vector-design-template_827767-2376.jpg?w=826" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Fix overscroll issues */
        html, body {
            overflow-x: hidden;
            overscroll-behavior: none;
            background-color: #f3f4f6;
        }

        html {
            height: 100%;
        }

        body {
            min-height: 100vh;
            background-color: #f3f4f6 !important;
        }

        /* Chat animations */
        .chat-message {
            animation: fadeInUp 0.3s ease-out;
        }

        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Sidebar styling */
        .sidebar {
            transition: transform 0.3s ease-in-out;
            background: linear-gradient(135deg, #065f46, #047857);
            display: block !important;
        }

        @media (min-width: 1024px) {
            .sidebar {
                transform: translateX(0) !important;
                position: fixed !important;
                left: 0 !important;
                top: 0 !important;
                width: 256px !important;
                height: 100vh !important;
                z-index: 50 !important;
            }
        }

        .sidebar-item {
            transition: all 0.3s ease;
            border-radius: 10px;
            margin: 5px 0;
        }

        .sidebar-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .sidebar-item.active {
            background-color: rgba(255, 255, 255, 0.2);
            border-left: 4px solid #10b981;
        }

        /* Mobile sidebar toggle */
        @media (max-width: 1023px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
        }

        /* Chat container */
        .chat-container {
            height: 400px;
            overflow-y: auto;
        }

        .chat-container::-webkit-scrollbar {
            width: 6px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* Loading animation */
        .loading-dots {
            display: inline-flex;
            align-items: center;
        }

        .loading-dots span {
            height: 8px;
            width: 8px;
            background-color: #10b981;
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: bounce 1.4s ease-in-out infinite both;
        }

        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        .loading-dots span:nth-child(3) { animation-delay: 0; }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        /* Quick suggestion buttons */
        .suggestion-btn {
            transition: all 0.2s ease;
        }

        .suggestion-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* AI Avatar animation */
        .ai-avatar {
            animation: pulse-glow 2s ease-in-out infinite alternate;
        }

        @keyframes pulse-glow {
            0% {
                box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
            }
            100% {
                box-shadow: 0 0 30px rgba(16, 185, 129, 0.8);
            }
        }
    </style>
</head>

<body class="bg-gray-100">
    <!-- Mobile Menu Overlay -->
    <div id="mobileOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar fixed left-0 top-0 w-64 h-full z-50 p-6 lg:block">
        <!-- Logo -->
        <div class="flex items-center mb-8">
            <i class="fas fa-leaf text-white text-2xl mr-3"></i>
            <h1 class="text-white text-xl font-bold">CropMate</h1>
        </div>

        <!-- Navigation Menu -->
        <nav class="space-y-2">
            <a href="{% url 'dashboard:dashboard' %}" class="sidebar-item flex items-center text-white p-3 block">
                <i class="fas fa-tachometer-alt mr-3"></i>
                Dashboard
            </a>
            <a href="{% url 'dashboard:agronomist' %}" class="sidebar-item active flex items-center text-white p-3 block">
                <i class="fas fa-seedling mr-3"></i>
                Agronomist
            </a>
            <a href="{% url 'dashboard:sensors' %}" class="sidebar-item flex items-center text-white p-3 block">
                <i class="fas fa-thermometer-half mr-3"></i>
                Sensor Data
            </a>
            <a href="#recommendations" class="sidebar-item flex items-center text-white p-3 block">
                <i class="fas fa-lightbulb mr-3"></i>
                Recommendations
            </a>
            <a href="{% url 'dashboard:weather' %}" class="sidebar-item flex items-center text-white p-3 block">
                <i class="fas fa-cloud-sun mr-3"></i>
                Weather
            </a>
            <a href="#reports" class="sidebar-item flex items-center text-white p-3 block">
                <i class="fas fa-chart-bar mr-3"></i>
                Reports
            </a>
            <a href="#settings" class="sidebar-item flex items-center text-white p-3 block">
                <i class="fas fa-cog mr-3"></i>
                Settings
            </a>
            <a href="{% url 'dashboard:logout' %}" class="sidebar-item flex items-center text-white p-3 block">
                <i class="fas fa-sign-out-alt mr-3"></i>
                Logout
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <div class="lg:ml-64 min-h-screen">
        <!-- Top Navigation -->
        <header class="bg-white shadow-md p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <button id="sidebarToggle" class="lg:hidden text-gray-600 hover:text-green-600 mr-4">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <h2 class="text-xl font-semibold text-gray-800">Virtual Agronomist</h2>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center bg-green-100 px-3 py-1 rounded-full">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></div>
                        <span class="text-green-700 text-sm font-medium">AI Online</span>
                    </div>
                    <div class="relative">
                        <i class="fas fa-bell text-gray-600 hover:text-green-600 cursor-pointer text-xl"></i>
                        <span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">1</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-user-circle text-gray-600 text-2xl mr-2"></i>
                        <span class="text-gray-700 font-medium">{{ user.username|title }}</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Agronomist Content -->
        <main class="p-6">
            <!-- Chat Interface -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Chat Container -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-lg shadow-lg">
                        <!-- Chat Header -->
                        <div class="bg-green-600 text-white p-3 rounded-t-lg">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-robot text-sm"></i>
                                </div>
                                <div>
                                    <h4 class="font-medium">AI Assistant</h4>
                                </div>
                            </div>
                        </div>

                        <!-- Chat Messages -->
                        <div id="chatContainer" class="chat-container p-4 space-y-4" style="height: 400px;">
                            <!-- Welcome Message -->
                            <div class="chat-message flex items-start">
                                <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                                    <i class="fas fa-robot text-white text-sm"></i>
                                </div>
                                <div class="bg-green-50 p-3 rounded-lg max-w-md">
                                    <p class="text-gray-800">Hi! I'm here to help with your farming questions. What would you like to know?</p>
                                </div>
                            </div>
                        </div>

                        <!-- Chat Input -->
                        <div class="border-t p-3">
                            <div class="flex items-center justify-between mb-2">
                                <button 
                                    onclick="clearChat()" 
                                    class="text-gray-500 hover:text-red-600 text-sm transition-colors"
                                    title="Clear Chat"
                                >
                                    <i class="fas fa-trash mr-1"></i> Clear Chat
                                </button>
                            </div>
                            <div class="flex space-x-2">
                                <input 
                                    type="text" 
                                    id="messageInput" 
                                    placeholder="Ask about farming..." 
                                    class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                    onkeypress="handleKeyPress(event)"
                                >
                                <button 
                                    onclick="sendMessage()" 
                                    id="sendBtn"
                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors"
                                >
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Sidebar -->
                <div class="space-y-4">
                    <!-- Quick Suggestions -->
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h4 class="font-medium text-gray-800 mb-3">Quick Questions</h4>
                        <div class="space-y-2">
                            <button onclick="askQuestion('What crops should I plant this season?')" class="suggestion-btn w-full text-left p-2 bg-green-50 hover:bg-green-100 rounded text-sm text-gray-700 transition-all">
                                <i class="fas fa-seedling mr-2 text-green-600 text-xs"></i>
                                Crop recommendations
                            </button>
                            <button onclick="askQuestion('How do I improve soil health?')" class="suggestion-btn w-full text-left p-2 bg-blue-50 hover:bg-blue-100 rounded text-sm text-gray-700 transition-all">
                                <i class="fas fa-leaf mr-2 text-blue-600 text-xs"></i>
                                Soil improvement
                            </button>
                            <button onclick="askQuestion('Help me identify pest problems')" class="suggestion-btn w-full text-left p-2 bg-red-50 hover:bg-red-100 rounded text-sm text-gray-700 transition-all">
                                <i class="fas fa-bug mr-2 text-red-600 text-xs"></i>
                                Pest control
                            </button>
                            <button onclick="askQuestion('When should I water my crops?')" class="suggestion-btn w-full text-left p-2 bg-cyan-50 hover:bg-cyan-100 rounded text-sm text-gray-700 transition-all">
                                <i class="fas fa-tint mr-2 text-cyan-600 text-xs"></i>
                                Irrigation advice
                            </button>
                        </div>
                    </div>

                    <!-- Farm Status -->
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h4 class="font-medium text-gray-800 mb-3">Current Status</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Temperature</span>
                                <span class="font-medium text-orange-600">28.5°C</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Humidity</span>
                                <span class="font-medium text-blue-600">65%</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Soil Moisture</span>
                                <span class="font-medium text-amber-600">42%</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Sensors</span>
                                <span class="font-medium text-green-600">8 online</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript -->
    <script>
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeSidebar();
        });

        // Sidebar functionality
        function initializeSidebar() {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            const mobileOverlay = document.getElementById('mobileOverlay');

            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('open');
                mobileOverlay.classList.toggle('hidden');
            });

            mobileOverlay.addEventListener('click', () => {
                sidebar.classList.remove('open');
                mobileOverlay.classList.add('hidden');
            });

            // Sidebar navigation
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (item.href && (item.href.includes('logout') || item.href.includes('dashboard') || item.href.includes('weather') || item.href.includes('sensors') || item.href.includes('agronomist'))) {
                        return;
                    }
                    
                    e.preventDefault();
                    document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
                    item.classList.add('active');
                });
            });
        }

        // Chat functionality
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) return;

            // Add user message
            addMessage(message, 'user');
            messageInput.value = '';

            // Show typing indicator
            showTypingIndicator();

            // Send to backend
            fetch('{% url "dashboard:ask_agronomist" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    'message': message
                })
            })
            .then(response => response.json())
            .then(data => {
                hideTypingIndicator();
                if (data.success) {
                    addMessage(data.response, 'ai');
                } else {
                    addMessage('Sorry, I encountered an error. Please try again.', 'ai');
                }
            })
            .catch(error => {
                hideTypingIndicator();
                addMessage('Sorry, I\'m having trouble connecting. Please try again later.', 'ai');
                console.error('Error:', error);
            });
        }

        function addMessage(message, sender) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message flex items-start';
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="flex items-start justify-end w-full">
                        <div class="bg-blue-600 text-white p-3 rounded-lg max-w-md mr-3">
                            <p>${message}</p>
                        </div>
                        <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-user text-white text-sm"></i>
                        </div>
                    </div>
                `;
                messageDiv.classList.add('justify-end');
            } else {
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="bg-green-50 p-3 rounded-lg max-w-md">
                        <p class="text-gray-800">${message}</p>
                    </div>
                `;
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const chatContainer = document.getElementById('chatContainer');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'chat-message flex items-start';
            typingDiv.innerHTML = `
                <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                    <i class="fas fa-robot text-white text-sm"></i>
                </div>
                <div class="bg-green-50 p-3 rounded-lg">
                    <div class="loading-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        function askQuestion(question) {
            document.getElementById('messageInput').value = question;
            sendMessage();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function clearChat() {
            const chatContainer = document.getElementById('chatContainer');
            // Keep only the welcome message
            chatContainer.innerHTML = `
                <div class="chat-message flex items-start">
                    <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="bg-green-50 p-3 rounded-lg max-w-md">
                        <p class="text-gray-800">Hi! I'm here to help with your farming questions. What would you like to know?</p>
                    </div>
                </div>
            `;
        }

        // Get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>

</html>