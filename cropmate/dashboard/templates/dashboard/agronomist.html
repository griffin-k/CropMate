{% extends "dashboard/base_authenticated.html" %}

{% block page_title %}Virtual Agronomist - CropMate{% endblock %}
{% block sidebar_agronomist %}active{% endblock %}

{% block extra_css %}
<style>
.chat-message {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.chat-container {
    height: calc(100vh - 320px);
    min-height: 500px;
    overflow-y: auto;
    scroll-behavior: smooth;
}

.chat-container::-webkit-scrollbar {
    width: 8px;
}

.chat-container::-webkit-scrollbar-track {
    background: #f9fafb;
    border-radius: 4px;
}

.chat-container::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, #10b981, #059669);
    border-radius: 4px;
}

.chat-container::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(180deg, #059669, #047857);
}

.loading-dots {
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.loading-dots span {
    height: 8px;
    width: 8px;
    background: linear-gradient(135deg, #10b981, #059669);
    border-radius: 50%;
    animation: bounce 1.4s ease-in-out infinite both;
}

.loading-dots span:nth-child(1) { animation-delay: -0.32s; }
.loading-dots span:nth-child(2) { animation-delay: -0.16s; }
.loading-dots span:nth-child(3) { animation-delay: 0; }

@keyframes bounce {
    0%, 80%, 100% { 
        transform: scale(0.8);
        opacity: 0.5;
    }
    40% { 
        transform: scale(1.2);
        opacity: 1;
    }
}

.suggestion-card {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.suggestion-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s;
}

.suggestion-card:hover::before {
    left: 100%;
}

.suggestion-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
}

.suggestion-card:active {
    transform: translateY(-2px);
}

.stat-card {
    transition: all 0.3s ease;
    border-left: 3px solid transparent;
}

.stat-card:hover {
    border-left-color: #10b981;
    background: #f9fafb;
}

.message-bubble {
    max-width: 75%;
    word-wrap: break-word;
}

.ai-message {
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    border: 1px solid #bbf7d0;
}

.user-message {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
}

.chat-input {
    transition: all 0.3s ease;
}

.chat-input:focus {
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

.send-button {
    background: linear-gradient(135deg, #10b981, #059669);
    transition: all 0.3s ease;
}

.send-button:hover {
    background: linear-gradient(135deg, #059669, #047857);
    transform: scale(1.05);
}

.send-button:active {
    transform: scale(0.95);
}

.status-badge {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

.icon-wrapper {
    transition: transform 0.3s ease;
}

.suggestion-card:hover .icon-wrapper {
    transform: scale(1.1) rotate(5deg);
}
</style>
{% endblock %}

{% block header_title %}
<div class="flex items-center">
    <i class="fas fa-robot text-green-600 mr-2"></i>
    <span>AI Agronomist Assistant</span>
</div>
{% endblock %}

{% block header_extra %}
<div class="flex items-center space-x-3">
    <div class="status-badge flex items-center bg-green-50 border border-green-200 px-3 py-1.5 rounded-full">
        <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
        <span class="text-green-700 text-sm font-medium">Online</span>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="max-w-full">
    <!-- Main Chat Area -->
    <div class="w-full">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100">
            <!-- Chat Header -->
            <div class="bg-gradient-to-r from-green-600 to-green-500 text-white p-5">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-white bg-opacity-20 backdrop-blur-sm rounded-full flex items-center justify-center mr-4">
                            <i class="fas fa-robot text-xl"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-lg">CropMate AI Assistant</h3>
                            <p class="text-green-100 text-sm">Your personal farming expert</p>
                        </div>
                    </div>
                    <button onclick="clearChat()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all duration-300 text-sm flex items-center" title="Clear Chat">
                        <i class="fas fa-trash-alt mr-2"></i>
                        Clear
                    </button>
                </div>
            </div>

            <!-- Chat Messages -->
            <div id="chatContainer" class="chat-container p-6 bg-gray-50">
                <div class="chat-message flex items-start mb-4">
                    <div class="w-10 h-10 bg-gradient-to-br from-green-600 to-green-500 rounded-full flex items-center justify-center mr-3 flex-shrink-0 shadow-md">
                        <i class="fas fa-robot text-white"></i>
                    </div>
                    <div class="message-bubble ai-message p-4 rounded-2xl rounded-tl-none shadow-sm">
                        <p class="text-gray-800 leading-relaxed">
                            Hello! I'm your AI agronomist assistant. I'm here to help you with:
                        </p>
                        <ul class="mt-2 space-y-1 text-gray-700 text-sm">
                            <li>Crop recommendations and planning</li>
                            <li>Pest and disease identification</li>
                            <li>Irrigation and water management</li>
                            <li>Soil health and fertilization</li>
                        </ul>
                        <p class="mt-3 text-gray-800">What would you like to know today?</p>
                    </div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="border-t border-gray-200 p-4 bg-white">
                <div class="flex space-x-3">
                    <input type="text" 
                           id="messageInput" 
                           placeholder="Type your question here..." 
                           class="chat-input flex-1 border-2 border-gray-200 rounded-xl px-5 py-3 text-sm focus:outline-none focus:border-green-500 transition-all"
                           onkeypress="handleKeyPress(event)">
                    <button onclick="sendMessage()" 
                            id="sendBtn" 
                            class="send-button text-white px-6 py-3 rounded-xl font-medium shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center min-w-[120px]">
                        <i class="fas fa-paper-plane mr-2"></i>
                        Send
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2 ml-1">
                    <i class="fas fa-info-circle mr-1"></i>
                    Press Enter to send or click the Send button
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message) return;

    addMessage(message, 'user');
    messageInput.value = '';
    showTypingIndicator();

    fetch('{% url "dashboard:ask_agronomist" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ 'message': message })
    })
    .then(response => response.json())
    .then(data => {
        hideTypingIndicator();
        if (data.success) {
            addMessage(data.response, 'ai');
        } else {
            addMessage('âš ï¸ Sorry, I encountered an error. Please try again.', 'ai');
        }
    })
    .catch(error => {
        hideTypingIndicator();
        addMessage('ðŸ”Œ Connection error. Please check your internet and try again.', 'ai');
        console.error('Error:', error);
    });
}

function addMessage(message, sender) {
    const chatContainer = document.getElementById('chatContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'chat-message flex items-start mb-4';
    
    // Format message with proper line breaks
    const formattedMessage = message.replace(/\n/g, '<br>');
    
    if (sender === 'user') {
        messageDiv.innerHTML = `
            <div class="flex items-start justify-end w-full">
                <div class="message-bubble user-message p-4 rounded-2xl rounded-tr-none shadow-md mr-3 text-white">
                    <p style="white-space: pre-line;">${formattedMessage}</p>
                </div>
                <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-500 rounded-full flex items-center justify-center flex-shrink-0 shadow-md">
                    <i class="fas fa-user text-white"></i>
                </div>
            </div>
        `;
        messageDiv.classList.add('justify-end');
    } else {
        messageDiv.innerHTML = `
            <div class="w-10 h-10 bg-gradient-to-br from-green-600 to-green-500 rounded-full flex items-center justify-center mr-3 flex-shrink-0 shadow-md">
                <i class="fas fa-robot text-white"></i>
            </div>
            <div class="message-bubble ai-message p-4 rounded-2xl rounded-tl-none shadow-sm">
                <p class="text-gray-800 leading-relaxed" style="white-space: pre-line;">${formattedMessage}</p>
            </div>
        `;
    }
    
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function showTypingIndicator() {
    const chatContainer = document.getElementById('chatContainer');
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typingIndicator';
    typingDiv.className = 'chat-message flex items-start mb-4';
    typingDiv.innerHTML = `
        <div class="w-10 h-10 bg-gradient-to-br from-green-600 to-green-500 rounded-full flex items-center justify-center mr-3 flex-shrink-0 shadow-md">
            <i class="fas fa-robot text-white"></i>
        </div>
        <div class="ai-message p-4 rounded-2xl rounded-tl-none shadow-sm">
            <div class="loading-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    `;
    chatContainer.appendChild(typingDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function hideTypingIndicator() {
    const indicator = document.getElementById('typingIndicator');
    if (indicator) indicator.remove();
}

function askQuestion(question) {
    document.getElementById('messageInput').value = question;
    sendMessage();
}

function handleKeyPress(event) {
    if (event.key === 'Enter') sendMessage();
}

function clearChat() {
    if (!confirm('Are you sure you want to clear the chat history?')) return;
    
    const chatContainer = document.getElementById('chatContainer');
    chatContainer.innerHTML = `
        <div class="chat-message flex items-start mb-4">
            <div class="w-10 h-10 bg-gradient-to-br from-green-600 to-green-500 rounded-full flex items-center justify-center mr-3 flex-shrink-0 shadow-md">
                <i class="fas fa-robot text-white"></i>
            </div>
            <div class="message-bubble ai-message p-4 rounded-2xl rounded-tl-none shadow-sm">
                <p class="text-gray-800 leading-relaxed">
                    Hello! I'm your AI agronomist assistant. I'm here to help you with:
                </p>
                <ul class="mt-2 space-y-1 text-gray-700 text-sm">
                    <li>Crop recommendations and planning</li>
                    <li>Pest and disease identification</li>
                    <li>Irrigation and water management</li>
                    <li>Soil health and fertilization</li>
                </ul>
                <p class="mt-3 text-gray-800">What would you like to know today?</p>
            </div>
        </div>
    `;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
