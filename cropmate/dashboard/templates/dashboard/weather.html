<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather - CropMate</title>
    <link rel="icon" href="https://img.freepik.com/premium-vector/agriculture-icon-logo-vector-design-template_827767-2376.jpg?w=826" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Fix overscroll issues */
        html, body {
            overflow-x: hidden;
            overscroll-behavior: none;
            background-color: #f3f4f6;
        }

        html {
            height: 100%;
        }

        body {
            min-height: 100vh;
            background-color: #f3f4f6 !important;
        }

        /* Weather card animations */
        .weather-card {
            transition: all 0.3s ease-in-out;
            border-radius: 15px;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateY(30px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .weather-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        /* Sidebar styling */
        .sidebar {
            transition: transform 0.3s ease-in-out;
            background: linear-gradient(135deg, #065f46, #047857);
            display: block !important;
        }

        @media (min-width: 1024px) {
            .sidebar {
                transform: translateX(0) !important;
                position: fixed !important;
                left: 0 !important;
                top: 0 !important;
                width: 256px !important;
                height: 100vh !important;
                z-index: 50 !important;
            }
        }

        .sidebar-item {
            transition: all 0.3s ease;
            border-radius: 10px;
            margin: 5px 0;
        }

        .sidebar-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .sidebar-item.active {
            background-color: rgba(255, 255, 255, 0.2);
            border-left: 4px solid #10b981;
        }

        /* Weather gradient backgrounds */
        .weather-sunny {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .weather-cloudy {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }

        .weather-rainy {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .weather-clear {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        /* Mobile sidebar toggle */
        @media (max-width: 1023px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
        }

        /* Custom dropdown styling */
        .city-dropdown {
            position: relative;
        }

        .dropdown-content {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .dropdown-content.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid #f3f4f6;
        }

        .dropdown-item:hover {
            background-color: #f3f4f6;
            color: #10b981;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        /* Loading spinner */
        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* CropMate logo loader */
        .cropmate-loader {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: logoRotate 2s linear infinite;
            box-shadow: 0 20px 40px rgba(16, 185, 129, 0.3);
            margin: 0 auto 1.5rem;
            border: 3px solid rgba(255, 255, 255, 0.2);
        }

        .cropmate-loader i {
            color: white;
            font-size: 2rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        @keyframes logoRotate {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.05); }
            100% { transform: rotate(360deg) scale(1); }
        }

        /* Temperature animation */
        .temperature-text {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* Weather icon animations */
        .weather-icon {
            transition: all 0.3s ease;
        }

        .weather-icon:hover {
            transform: scale(1.1) rotate(10deg);
        }

        /* Chart container */
        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Custom scrollbar */
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }
    </style>
</head>

<body class="bg-gray-100">
    <!-- Mobile Menu Overlay -->
    <div id="mobileOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar fixed left-0 top-0 w-64 h-full z-50 p-6 lg:block">
        <!-- Logo -->
        <div class="flex items-center mb-8">
            <i class="fas fa-leaf text-white text-2xl mr-3"></i>
            <h1 class="text-white text-xl font-bold">CropMate</h1>
        </div>

        <!-- Navigation Menu -->
        <nav class="space-y-2">
            <a href="{% url 'dashboard:dashboard' %}" class="sidebar-item flex items-center text-white p-3 block">
                <i class="fas fa-tachometer-alt mr-3"></i>
                Dashboard
            </a>
            <a href="{% url 'dashboard:agronomist' %}" class="sidebar-item flex items-center text-white p-3 block">
                <i class="fas fa-seedling mr-3"></i>
                Agronomist
            </a>
            <a href="{% url 'dashboard:sensors' %}" class="sidebar-item flex items-center text-white p-3 block">
                <i class="fas fa-thermometer-half mr-3"></i>
                Sensor Data
            </a>
            <a href="#recommendations" class="sidebar-item flex items-center text-white p-3 block">
                <i class="fas fa-lightbulb mr-3"></i>
                Recommendations
            </a>
            <a href="{% url 'dashboard:weather' %}" class="sidebar-item active flex items-center text-white p-3 block">
                <i class="fas fa-cloud-sun mr-3"></i>
                Weather
            </a>
            <a href="#reports" class="sidebar-item flex items-center text-white p-3 block">
                <i class="fas fa-chart-bar mr-3"></i>
                Reports
            </a>
            <a href="#settings" class="sidebar-item flex items-center text-white p-3 block">
                <i class="fas fa-cog mr-3"></i>
                Settings
            </a>
            <a href="{% url 'dashboard:logout' %}" class="sidebar-item flex items-center text-white p-3 block">
                <i class="fas fa-sign-out-alt mr-3"></i>
                Logout
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <div class="lg:ml-64 min-h-screen">
        <!-- Top Navigation -->
        <header class="bg-white shadow-md p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <button id="sidebarToggle" class="lg:hidden text-gray-600 hover:text-green-600 mr-4">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <h2 class="text-xl font-semibold text-gray-800">Weather Forecast</h2>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <i class="fas fa-bell text-gray-600 hover:text-green-600 cursor-pointer text-xl"></i>
                        <span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">3</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-user-circle text-gray-600 text-2xl mr-2"></i>
                        <span class="text-gray-700 font-medium">{{ user.username|title }}</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Weather Content -->
        <main class="p-6">
            <!-- City Selection -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Select Location</h3>
                    <i class="fas fa-map-marker-alt text-green-600"></i>
                </div>
                
                <div class="city-dropdown">
                    <div class="relative">
                        <input 
                            type="text" 
                            id="citySearch" 
                            placeholder="Search for a city..." 
                            class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none transition-colors"
                            autocomplete="off"
                        >
                        <i class="fas fa-search absolute right-3 top-3.5 text-gray-400"></i>
                    </div>
                    <div id="cityDropdown" class="dropdown-content">
                        <!-- Cities will be populated here -->
                    </div>
                </div>

                <div class="mt-4">
                    <p class="text-sm text-center text-gray-600">
                       
                        Select a city to view current weather conditions and forecast
                    </p>
                </div>
            </div>

            <!-- Current Weather Card -->
            <div id="currentWeather" class="hidden mb-8">
                <div class="weather-card bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800" id="currentLocation">Current Weather</h3>
                            <p class="text-sm text-gray-600" id="currentDateTime"></p>
                        </div>
                        <div class="text-right">
                            <span class="temperature-text text-4xl font-bold text-gray-800" id="currentTemp">--°C</span>
                            <p class="text-sm text-gray-600" id="currentCondition">--</p>
                        </div>
                    </div>
                    
                    <!-- Primary Weather Stats -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <i class="fas fa-tint text-blue-600 text-2xl mb-2"></i>
                            <p class="text-sm text-gray-600">Humidity</p>
                            <p class="font-semibold text-gray-800" id="currentHumidity">--%</p>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <i class="fas fa-wind text-green-600 text-2xl mb-2"></i>
                            <p class="text-sm text-gray-600">Wind Speed</p>
                            <p class="font-semibold text-gray-800" id="currentWindSpeed">-- km/h</p>
                        </div>
                        <div class="text-center p-4 bg-yellow-50 rounded-lg">
                            <i class="fas fa-thermometer-half text-yellow-600 text-2xl mb-2"></i>
                            <p class="text-sm text-gray-600">Feels Like</p>
                            <p class="font-semibold text-gray-800" id="currentFeelsLike">--°C</p>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-lg">
                            <i class="fas fa-eye text-purple-600 text-2xl mb-2"></i>
                            <p class="text-sm text-gray-600">Visibility</p>
                            <p class="font-semibold text-gray-800" id="currentVisibility">-- km</p>
                        </div>
                    </div>

                    <!-- Additional Weather Data -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center p-4 bg-red-50 rounded-lg">
                            <i class="fas fa-thermometer-three-quarters text-red-600 text-2xl mb-2"></i>
                            <p class="text-sm text-gray-600">Pressure</p>
                            <p class="font-semibold text-gray-800" id="currentPressure">-- hPa</p>
                        </div>
                        <div class="text-center p-4 bg-orange-50 rounded-lg">
                            <i class="fas fa-sun text-orange-600 text-2xl mb-2"></i>
                            <p class="text-sm text-gray-600">UV Index</p>
                            <p class="font-semibold text-gray-800" id="currentUV">--</p>
                        </div>
                        <div class="text-center p-4 bg-cyan-50 rounded-lg">
                            <i class="fas fa-cloud-rain text-cyan-600 text-2xl mb-2"></i>
                            <p class="text-sm text-gray-600">Rain (1h)</p>
                            <p class="font-semibold text-gray-800" id="currentRain">-- mm</p>
                        </div>
                        <div class="text-center p-4 bg-indigo-50 rounded-lg">
                            <i class="fas fa-compass text-indigo-600 text-2xl mb-2"></i>
                            <p class="text-sm text-gray-600">Wind Dir</p>
                            <p class="font-semibold text-gray-800" id="currentWindDir">--</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rain & Precipitation Data -->
            <div id="precipitationData" class="hidden mb-8">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-gray-800">Precipitation Data</h3>
                        <i class="fas fa-cloud-rain text-blue-600"></i>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="text-center p-6 bg-blue-50 rounded-lg">
                            <i class="fas fa-cloud-showers-heavy text-blue-600 text-3xl mb-3"></i>
                            <p class="text-sm text-gray-600">Today's Rain</p>
                            <p class="font-bold text-2xl text-gray-800" id="todayRain">-- mm</p>
                        </div>
                        <div class="text-center p-6 bg-cyan-50 rounded-lg">
                            <i class="fas fa-umbrella text-cyan-600 text-3xl mb-3"></i>
                            <p class="text-sm text-gray-600">Rain Probability</p>
                            <p class="font-bold text-2xl text-gray-800" id="rainProbability">--%</p>
                        </div>
                        <div class="text-center p-6 bg-indigo-50 rounded-lg">
                            <i class="fas fa-tint text-indigo-600 text-3xl mb-3"></i>
                            <p class="text-sm text-gray-600">Weekly Total</p>
                            <p class="font-bold text-2xl text-gray-800" id="weeklyRain">-- mm</p>
                        </div>
                    </div>

                    <!-- Hourly Precipitation Chart -->
                    <div class="chart-container">
                        <canvas id="precipitationChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- 7-Day Forecast -->
            <div id="forecastWeather" class="hidden mb-8">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-gray-800">7-Day Forecast</h3>
                        <i class="fas fa-calendar-week text-green-600"></i>
                    </div>
                    
                    <div id="forecastContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-7 gap-4">
                        <!-- Forecast cards will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Temperature Chart -->
            <div id="temperatureChart" class="hidden mb-8">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Temperature Trend</h3>
                        <i class="fas fa-chart-line text-green-600"></i>
                    </div>
                    <div class="chart-container">
                        <canvas id="tempChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="hidden text-center py-12">
                <div class="cropmate-loader">
                    <i class="fas fa-leaf"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Fetching Weather Data</h3>
                <p class="text-gray-600">Getting the latest forecast for your location...</p>
                <div class="flex justify-center items-center mt-4 space-x-2">
                    <div class="w-2 h-2 bg-green-500 rounded-full animate-bounce" style="animation-delay: 0s;"></div>
                    <div class="w-2 h-2 bg-green-500 rounded-full animate-bounce" style="animation-delay: 0.1s;"></div>
                    <div class="w-2 h-2 bg-green-500 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                </div>
            </div>

            <!-- Error State -->
            <div id="errorState" class="hidden text-center py-12">
                <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                <p class="text-gray-600 mb-2">Unable to fetch weather data</p>
                <p class="text-sm text-gray-500">Please try selecting a different city</p>
            </div>
        </main>

        {% comment %} <!-- Footer -->
        <footer class="bg-green-700 text-white text-center py-4 mt-8">
            <p>&copy; 2025 CropMate. All Rights Reserved. Developed By Amna Asad</p>
        </footer> {% endcomment %}
    </div>

    <!-- JavaScript -->
    <script>
        // Cities data with coordinates for Pakistan (Punjab and Sindh)
        const cities = [
            { name: 'Lahore', lat: 31.5497, lon: 74.3436, province: 'Punjab' },
            { name: 'Bahawalpur', lat: 29.4000, lon: 71.6833, province: 'Punjab' },
            { name: 'Multan', lat: 30.1575, lon: 71.5249, province: 'Punjab' },
            { name: 'Islamabad', lat: 33.6844, lon: 73.0479, province: 'Federal' },
            { name: 'Karachi', lat: 24.8607, lon: 67.0011, province: 'Sindh' },
            { name: 'Faisalabad', lat: 31.4504, lon: 73.1350, province: 'Punjab' },
            { name: 'Rawalpindi', lat: 33.5651, lon: 73.0169, province: 'Punjab' },
            { name: 'Gujranwala', lat: 32.1877, lon: 74.1945, province: 'Punjab' },
            { name: 'Peshawar', lat: 34.0151, lon: 71.5249, province: 'KPK' },
            { name: 'Hyderabad', lat: 25.3960, lon: 68.3578, province: 'Sindh' },
            { name: 'Sialkot', lat: 32.4945, lon: 74.5229, province: 'Punjab' },
            { name: 'Sargodha', lat: 32.0836, lon: 72.6711, province: 'Punjab' },
            { name: 'Sukkur', lat: 27.7058, lon: 68.8574, province: 'Sindh' },
            { name: 'Larkana', lat: 27.5590, lon: 68.2123, province: 'Sindh' },
            { name: 'Nawabshah', lat: 26.2442, lon: 68.4103, province: 'Sindh' },
            { name: 'Mirpurkhas', lat: 25.5276, lon: 69.0142, province: 'Sindh' },
            { name: 'Kasur', lat: 31.1180, lon: 74.4507, province: 'Punjab' },
            { name: 'Sahiwal', lat: 30.6682, lon: 73.1114, province: 'Punjab' },
            { name: 'Okara', lat: 30.8081, lon: 73.4534, province: 'Punjab' },
            { name: 'Jhang', lat: 31.2782, lon: 72.3317, province: 'Punjab' }
        ];

        let selectedCity = null;
        let tempChart = null;
        let precipitationChart = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeCitySearch();
            initializeSidebar();
        });

        // City search functionality
        function initializeCitySearch() {
            const searchInput = document.getElementById('citySearch');
            const dropdown = document.getElementById('cityDropdown');

            // Populate dropdown with all cities initially
            populateDropdown(cities);

            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                const filteredCities = cities.filter(city => 
                    city.name.toLowerCase().includes(query) || 
                    city.province.toLowerCase().includes(query)
                );
                populateDropdown(filteredCities);
                
                if (query.length > 0) {
                    dropdown.classList.add('show');
                } else {
                    dropdown.classList.remove('show');
                }
            });

            searchInput.addEventListener('focus', function() {
                dropdown.classList.add('show');
            });

            document.addEventListener('click', function(e) {
                if (!e.target.closest('.city-dropdown')) {
                    dropdown.classList.remove('show');
                }
            });
        }

        function populateDropdown(cityList) {
            const dropdown = document.getElementById('cityDropdown');
            dropdown.innerHTML = '';

            if (cityList.length === 0) {
                dropdown.innerHTML = '<div class="dropdown-item">No cities found</div>';
                return;
            }

            cityList.forEach(city => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="font-medium">${city.name}</span>
                        <span class="text-sm text-gray-500">${city.province}</span>
                    </div>
                `;
                item.addEventListener('click', () => selectCity(city));
                dropdown.appendChild(item);
            });
        }

        function selectCity(city) {
            selectedCity = city;
            document.getElementById('citySearch').value = `${city.name}, ${city.province}`;
            document.getElementById('cityDropdown').classList.remove('show');
            
            // Show loading state
            showLoadingState();
            
            // Fetch weather data
            fetchWeatherData(city.lat, city.lon, city.name);
        }

        function showLoadingState() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('currentWeather').classList.add('hidden');
            document.getElementById('precipitationData').classList.add('hidden');
            document.getElementById('forecastWeather').classList.add('hidden');
            document.getElementById('temperatureChart').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
        }

        function showWeatherData() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('currentWeather').classList.remove('hidden');
            document.getElementById('precipitationData').classList.remove('hidden');
            document.getElementById('forecastWeather').classList.remove('hidden');
            document.getElementById('temperatureChart').classList.remove('hidden');
            document.getElementById('errorState').classList.add('hidden');
        }

        function showErrorState() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('currentWeather').classList.add('hidden');
            document.getElementById('precipitationData').classList.add('hidden');
            document.getElementById('forecastWeather').classList.add('hidden');
            document.getElementById('temperatureChart').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
        }

        async function fetchWeatherData(lat, lon, cityName) {
            try {
                // Fetch comprehensive weather data including precipitation, pressure, UV index, wind direction
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,wind_speed_10m,wind_direction_10m,weather_code,visibility,surface_pressure,uv_index,rain,precipitation&daily=weather_code,temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,precipitation_sum,precipitation_probability_max,uv_index_max&hourly=temperature_2m,precipitation,precipitation_probability&timezone=auto`);
                
                if (!response.ok) {
                    throw new Error('Weather data fetch failed');
                }

                const data = await response.json();
                
                // Update current weather
                updateCurrentWeather(data, cityName);
                
                // Update precipitation data
                updatePrecipitationData(data);
                
                // Update 7-day forecast
                updateForecast(data.daily);
                
                // Update temperature chart
                updateTemperatureChart(data.hourly);
                
                // Update precipitation chart
                updatePrecipitationChart(data.hourly);
                
                showWeatherData();
            } catch (error) {
                console.error('Error fetching weather data:', error);
                showErrorState();
            }
        }

        function updateCurrentWeather(data, cityName) {
            const current = data.current;
            const now = new Date();

            document.getElementById('currentLocation').textContent = `${cityName} - Current Weather`;
            document.getElementById('currentDateTime').textContent = now.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            document.getElementById('currentTemp').textContent = `${Math.round(current.temperature_2m)}°C`;
            document.getElementById('currentCondition').textContent = getWeatherCondition(current.weather_code);
            document.getElementById('currentHumidity').textContent = `${current.relative_humidity_2m}%`;
            document.getElementById('currentWindSpeed').textContent = `${Math.round(current.wind_speed_10m)} km/h`;
            document.getElementById('currentFeelsLike').textContent = `${Math.round(current.apparent_temperature)}°C`;
            document.getElementById('currentVisibility').textContent = `${Math.round(current.visibility / 1000)} km`;
            
            // Additional weather data
            document.getElementById('currentPressure').textContent = `${Math.round(current.surface_pressure)} hPa`;
            document.getElementById('currentUV').textContent = current.uv_index ? Math.round(current.uv_index) : 'N/A';
            document.getElementById('currentRain').textContent = `${current.rain || 0} mm`;
            document.getElementById('currentWindDir').textContent = getWindDirection(current.wind_direction_10m);
        }

        function updateForecast(daily) {
            const container = document.getElementById('forecastContainer');
            container.innerHTML = '';

            for (let i = 0; i < 7; i++) {
                const date = new Date(daily.time[i]);
                const dayName = i === 0 ? 'Today' : date.toLocaleDateString('en-US', { weekday: 'short' });
                
                const forecastCard = document.createElement('div');
                forecastCard.className = 'weather-card bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg text-center';
                
                forecastCard.innerHTML = `
                    <p class="font-medium text-gray-800 mb-2">${dayName}</p>
                    <i class="${getWeatherIcon(daily.weather_code[i])} weather-icon text-2xl text-blue-600 mb-2"></i>
                    <div class="space-y-1">
                        <p class="font-bold text-gray-800">${Math.round(daily.temperature_2m_max[i])}°</p>
                        <p class="text-sm text-gray-600">${Math.round(daily.temperature_2m_min[i])}°</p>
                        <div class="flex items-center justify-center text-xs text-gray-500 mt-2">
                            <i class="fas fa-cloud-rain mr-1"></i>
                            <span>${Math.round(daily.precipitation_sum[i])} mm</span>
                        </div>
                        <div class="flex items-center justify-center text-xs text-gray-500">
                            <i class="fas fa-percentage mr-1"></i>
                            <span>${daily.precipitation_probability_max[i]}%</span>
                        </div>
                    </div>
                `;
                
                container.appendChild(forecastCard);
            }
        }

        function updateTemperatureChart(hourly) {
            const ctx = document.getElementById('tempChart').getContext('2d');
            
            // Get next 24 hours of data
            const labels = [];
            const temperatures = [];
            
            for (let i = 0; i < 24; i++) {
                const hour = new Date(hourly.time[i]).getHours();
                labels.push(`${hour}:00`);
                temperatures.push(hourly.temperature_2m[i]);
            }

            if (tempChart) {
                tempChart.destroy();
            }

            tempChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Temperature (°C)',
                        data: temperatures,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Temperature (°C)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time (24 Hours)'
                            }
                        }
                    }
                }
            });
        }

        function getWeatherCondition(code) {
            const conditions = {
                0: 'Clear sky',
                1: 'Mainly clear',
                2: 'Partly cloudy',
                3: 'Overcast',
                45: 'Foggy',
                48: 'Depositing rime fog',
                51: 'Light drizzle',
                53: 'Moderate drizzle',
                55: 'Dense drizzle',
                61: 'Slight rain',
                63: 'Moderate rain',
                65: 'Heavy rain',
                71: 'Slight snow',
                73: 'Moderate snow',
                75: 'Heavy snow',
                95: 'Thunderstorm'
            };
            return conditions[code] || 'Unknown';
        }

        function getWeatherIcon(code) {
            const icons = {
                0: 'fas fa-sun',
                1: 'fas fa-sun',
                2: 'fas fa-cloud-sun',
                3: 'fas fa-cloud',
                45: 'fas fa-smog',
                48: 'fas fa-smog',
                51: 'fas fa-cloud-rain',
                53: 'fas fa-cloud-rain',
                55: 'fas fa-cloud-rain',
                61: 'fas fa-cloud-showers-heavy',
                63: 'fas fa-cloud-showers-heavy',
                65: 'fas fa-cloud-showers-heavy',
                71: 'fas fa-snowflake',
                73: 'fas fa-snowflake',
                75: 'fas fa-snowflake',
                95: 'fas fa-bolt'
            };
            return icons[code] || 'fas fa-question';
        }

        function updatePrecipitationData(data) {
            const daily = data.daily;
            const hourly = data.hourly;
            
            // Calculate today's rain (first day)
            const todayRain = daily.precipitation_sum[0];
            document.getElementById('todayRain').textContent = `${Math.round(todayRain * 10) / 10} mm`;
            
            // Today's rain probability (first day)
            const rainProb = daily.precipitation_probability_max[0];
            document.getElementById('rainProbability').textContent = `${rainProb}%`;
            
            // Calculate weekly total
            const weeklyTotal = daily.precipitation_sum.slice(0, 7).reduce((sum, rain) => sum + rain, 0);
            document.getElementById('weeklyRain').textContent = `${Math.round(weeklyTotal * 10) / 10} mm`;
        }

        function updatePrecipitationChart(hourly) {
            const ctx = document.getElementById('precipitationChart').getContext('2d');
            
            // Get next 24 hours of precipitation data
            const labels = [];
            const precipitation = [];
            
            for (let i = 0; i < 24; i++) {
                const hour = new Date(hourly.time[i]).getHours();
                labels.push(`${hour}:00`);
                precipitation.push(hourly.precipitation[i] || 0);
            }

            if (precipitationChart) {
                precipitationChart.destroy();
            }

            precipitationChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Precipitation (mm)',
                        data: precipitation,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: '#3b82f6',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: '24-Hour Precipitation Forecast'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Precipitation (mm)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time (24 Hours)'
                            }
                        }
                    }
                }
            });
        }

        function getWindDirection(degrees) {
            if (!degrees && degrees !== 0) return 'N/A';
            
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            const index = Math.round(degrees / 22.5) % 16;
            return directions[index];
        }

        // Sidebar functionality
        function initializeSidebar() {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            const mobileOverlay = document.getElementById('mobileOverlay');

            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('open');
                mobileOverlay.classList.toggle('hidden');
            });

            mobileOverlay.addEventListener('click', () => {
                sidebar.classList.remove('open');
                mobileOverlay.classList.add('hidden');
            });

            // Sidebar navigation
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    // Don't prevent default for logout link
                    if (item.href && item.href.includes('logout')) {
                        return; // Let the logout link work normally
                    }
                    
                    // Don't prevent default for weather and dashboard links
                    if (item.href && (item.href.includes('weather') || item.href.includes('dashboard') || item.href.includes('sensors'))) {
                        return; // Let these links work normally
                    }
                    
                    e.preventDefault();
                    // Remove active class from all items
                    document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
                    // Add active class to clicked item
                    item.classList.add('active');
                });
            });
        }
    </script>
</body>

</html>